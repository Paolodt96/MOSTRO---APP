<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Bestiario - Editor Mostri</title>

  <!-- Per mobile / app-like -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2a1a12">

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.json">

  <!-- FONT (stile fantasy) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      min-height: 100%;
    }

    body {
      background: #2a1a12;  /* sfondo esterno scuro (solo video) */
      font-family: "Crimson Text", serif;
      padding: 20px 0;
      color: #f7e4c4;
    }

    /* VISTE PRINCIPALI */
    #view-library,
    #view-editor {
      max-width: 210mm;
      margin: 0 auto;
    }

    /* ================
       VISTA LIBRERIA
       ================ */
    .library-wrapper {
      background: #1a100b;
      border: 1px solid #5b3c22;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
      padding: 16px 18px 18px;
      border-radius: 4px;
    }

    .library-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
      border-bottom: 1px solid #5b3c22;
      padding-bottom: 6px;
    }

    .library-title {
      font-family: "Cinzel", serif;
      font-size: 20px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .library-subtitle {
      font-size: 11px;
      opacity: 0.8;
      margin-left: 8px;
    }

    .library-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .lib-btn {
      background: rgba(40, 20, 12, 0.85);
      color: #f7e4c4;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid #d2a569;
      font-size: 11px;
    }

    .lib-btn:hover {
      background: rgba(60, 30, 18, 0.9);
    }

    .template-select-label {
      font-size: 11px;
      color: #f7e4c4;
    }

    #template-select {
      background: #2a1a12;
      color: #f7e4c4;
      border: 1px solid #5b3c22;
      border-radius: 4px;
      padding: 3px 6px;
      font-size: 11px;
    }

    .library-search {
      margin: 8px 0 10px;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .library-search input {
      flex: 1;
      padding: 4px 6px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #5b3c22;
      background: #2a1a12;
      color: #f7e4c4;
    }

    .library-search input::placeholder {
      color: #b49a72;
      font-style: italic;
    }

    .monster-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 70vh;
      overflow-y: auto;
      padding-right: 4px;
    }

    .monster-empty {
      font-size: 12px;
      font-style: italic;
      opacity: 0.8;
      margin-top: 10px;
    }

    .monster-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      border-radius: 4px;
      background: #24130d;
      border: 1px solid #5b3c22;
      gap: 8px;
    }

    .monster-card-main {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .monster-card-title {
      font-size: 14px;
      font-family: "Cinzel", serif;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .monster-card-subtitle {
      font-size: 11px;
      opacity: 0.8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .monster-card-meta {
      font-size: 10px;
      opacity: 0.7;
    }

    .monster-card-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    .monster-card-actions button {
      background: rgba(60, 30, 18, 0.9);
      color: #f7e4c4;
      border-radius: 4px;
      border: 1px solid #d2a569;
      font-size: 10px;
      padding: 3px 6px;
      cursor: pointer;
      white-space: nowrap;
    }

    .monster-card-actions button:hover {
      background: rgba(90, 40, 22, 0.95);
    }

    /* ================
         VISTA EDITOR
       ================ */

    .page {
      width: 210mm;
      height: 297mm;
      padding: 15mm;
      background: url("pergamena.jpg") center center / cover no-repeat;
      border: 1px solid #5b3c22;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);

      display: flex;
      flex-direction: column;
      margin: 0 auto;
      overflow: hidden;

      color: #2a1208;
    }

    .toolbar {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-bottom: 5mm;
      font-size: 11px;
      flex: 0 0 auto;
      flex-wrap: wrap;
    }

    .btn,
    .toolbar label {
      background: rgba(40, 20, 12, 0.85);
      color: #f7e4c4;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid #d2a569;
      font-size: 11px;
    }

    .btn:hover,
    .toolbar label:hover {
      background: rgba(60, 30, 18, 0.9);
    }

    .toolbar input[type="file"] {
      display: none;
    }

    .monster-layout {
      display: flex;
      width: 100%;
      height: 100%;
      gap: 10mm;
      flex: 1 1 auto;
    }

    .left-column {
      position: relative;
      flex: 0 0 60%;
      max-width: 60%;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 4mm;

      overflow: hidden;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
    }

    .right-column {
      flex: 1;
      position: relative;
      height: 100%;
      overflow: hidden;
    }

    [contenteditable="true"] {
      cursor: text;
    }

    [contenteditable="true"]:hover {
      outline: 1px dashed rgba(0,0,0,0.35);
    }

    [contenteditable="true"]:focus {
      outline: 1px solid rgba(0,0,0,0.6);
      background-color: rgba(255,255,255,0.02);
    }

    .monster-header {
      font-family: "Cinzel", serif;
      padding: 6px 8px;
      background: rgba(120, 46, 28, 0.95);
      border: 1px solid #3b1c10;
      color: #fdf4dc;
      font-size: 20px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .monster-subtitle {
      padding: 2px 8px 0;
      font-style: italic;
      font-size: 11px;
    }

    .monster-lore {
      padding: 4px 8px;
      font-size: 12px;
      line-height: 1.4;
      text-align: justify;

      overflow: hidden;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .monster-lore p + p {
      margin-top: 4px;
    }

    .stat-block {
      margin-top: 2px;
      border-top: 4px solid #7b3b1b;
      border-bottom: 2px solid #7b3b1b;
      background: rgba(252, 244, 220, 0.96);
      font-size: 11px;

      overflow: hidden;
      word-wrap: break-word;
      overflow-wrap: break-word;
      color: #2a1208;
    }

    .stat-title {
      background: #cfa46a;
      border-bottom: 1px solid #7b3b1b;
      padding: 4px 8px;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 11px;
    }

    .stat-row {
      padding: 4px 8px;
      border-bottom: 1px solid rgba(123, 59, 27, 0.25);
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .ability-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 2px;
      margin-top: 4px;
    }

    .ability {
      text-align: center;
      font-size: 10px;
    }

    .ability span {
      display: block;
    }

    .ability span.score {
      font-weight: bold;
      margin-top: 1px;
    }

    .section-label {
      font-variant: small-caps;
      font-weight: bold;
    }

    .trait-name,
    .action-name {
      font-weight: bold;
      font-style: italic;
    }

    .trait + .trait,
    .action + .action {
      margin-top: 2px;
    }

    .monster-art-wrapper {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
    }

    #monster-art {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    @page {
      size: A4;
      margin: 0;
    }

    @media print {
      html, body {
        margin: 0;
        padding: 0;
        background: none;
      }

      #view-library {
        display: none !important;
      }

      .toolbar {
        display: none !important;
      }

      #view-editor {
        max-width: none;
        margin: 0;
      }

      .page {
        margin: 0;
        border: none;
        box-shadow: none;
        width: 210mm;
        height: 297mm;
        padding: 15mm;
        background: url("pergamena.jpg") center center / cover no-repeat;
      }
    }
  </style>

  <!-- Librerie per export immagine e ZIP -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('service-worker.js')
          .catch(function (err) {
            console.warn('Service worker non registrato:', err);
          });
      });
    }
  </script>
</head>
<body>

  <!-- VISTA LIBRERIA MOSTRI -->
  <div id="view-library">
    <div class="library-wrapper">
      <div class="library-header">
        <div>
          <div class="library-title">Bestiario</div>
          <div class="library-subtitle">Archivio dei mostri del master</div>
        </div>
        <div class="library-actions">
          <span class="template-select-label">Template:</span>
          <select id="template-select">
            <option value="standard">Mostro standard</option>
            <option value="boss">Boss / Leggendario</option>
            <option value="npc">PNG importante</option>
            <option value="minion">Minion / Branco</option>
          </select>
          <button type="button" class="lib-btn" id="btn-new-monster">Nuovo mostro</button>
        </div>
      </div>

      <div class="library-search">
        <input type="text" id="monster-search" placeholder="Cerca per nome o tipo...">
      </div>

      <div id="monster-list" class="monster-list"></div>
      <div id="monster-empty" class="monster-empty" style="display:none;">
        Nessun mostro salvato. Crea il tuo primo mostro con il pulsante “Nuovo mostro”.
      </div>
    </div>
  </div>

  <!-- VISTA EDITOR -->
  <div id="view-editor" style="display:none;">
    <div class="page" id="page">
      <div class="toolbar">
        <button type="button" class="btn" data-action="export">Esporta PDF</button>
        <button type="button" class="btn" data-action="export-png">Esporta PNG</button>
        <button type="button" class="btn" data-action="export-json">Esporta JSON</button>
        <label>
          Importa JSON
          <input type="file" id="jsonUpload" accept="application/json">
        </label>
        <button type="button" class="btn" data-action="export-zip">Esporta ZIP</button>

        <button type="button" class="btn" data-action="undo">Undo</button>
        <button type="button" class="btn" data-action="redo">Redo</button>

        <label>
          Carica immagine
          <input type="file" id="imageUpload" accept="image/*">
        </label>

        <button type="button" class="btn" data-action="add-trait">+ Tratto</button>
        <button type="button" class="btn" data-action="add-multi">+ Multiattacco</button>
        <button type="button" class="btn" data-action="add-action">+ Azione</button>
        <button type="button" class="btn" data-action="add-legendary">+ Az. leggendaria</button>
        <button type="button" class="btn" data-action="add-reaction">+ Reazione</button>

        <button type="button" class="btn" data-action="text-dark">Testo scuro</button>

        <button type="button" class="btn" data-action="save">Salva mostro</button>
        <button type="button" class="btn" data-action="library">Libreria</button>
      </div>

      <div class="monster-layout">
        <section class="left-column">
          <header class="monster-header" contenteditable="true">
            Nome del Mostro
          </header>

          <div class="monster-subtitle" contenteditable="true">
            Taglia media, mostruosità, neutrale malvagio
          </div>

          <section class="monster-lore" contenteditable="true">
            <p>
              Scrivi qui la descrizione narrativa del mostro: origine, comportamento,
              territorio, leggende e qualsiasi dettaglio utile al master.
            </p>
            <p>
              Questa sezione è completamente editabile: clicca e scrivi come in un documento.
            </p>
          </section>

          <section class="stat-block" contenteditable="true">
            <div class="stat-title">
              Blocco statistiche
            </div>

            <div class="stat-row">
              <span class="section-label">Classe Armatura</span> 15 (pelle coriacea)<br>
              <span class="section-label">Punti Ferita</span> 68 (8d10 + 24)<br>
              <span class="section-label">Velocità</span> 9 m
            </div>

            <div class="stat-row">
              <div class="ability-grid">
                <div class="ability"><span>FOR</span><span class="score">16 (+3)</span></div>
                <div class="ability"><span>DES</span><span class="score">14 (+2)</span></div>
                <div class="ability"><span>COS</span><span class="score">16 (+3)</span></div>
                <div class="ability"><span>INT</span><span class="score">8 (-1)</span></div>
                <div class="ability"><span>SAG</span><span class="score">12 (+1)</span></div>
                <div class="ability"><span>CAR</span><span class="score">10 (+0)</span></div>
              </div>
            </div>

            <div class="stat-row">
              <span class="section-label">Tiri Salvezza</span> DES +4, COS +5<br>
              <span class="section-label">Abilità</span> Percezione +3, Furtività +4<br>
              <span class="section-label">Sensi</span> scurovisione 18 m, Percezione passiva 13<br>
              <span class="section-label">Linguaggi</span> —<br>
              <span class="section-label">Grado di Sfida</span> 4 (1.100 PE)
            </div>

            <div class="stat-row">
              <div class="trait">
                <span class="trait-name">Fiuto del Predatore.</span>
                Testo abilità speciale…
              </div>
              <div class="trait">
                <span class="trait-name">Agguato.</span>
                Testo abilità speciale…
              </div>
            </div>

            <div class="stat-row">
              <span class="section-label">Azioni</span>
              <div class="action">
                <span class="action-name">Multiattacco.</span>
                Testo azione…
              </div>
              <div class="action">
                <span class="action-name">Artigli.</span>
                Testo attacco…
              </div>
            </div>
          </section>
        </section>

        <aside class="right-column">
          <div class="monster-art-wrapper">
            <img id="monster-art" src="" alt="Illustrazione del mostro">
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    const page = document.getElementById('page');
    const img = document.getElementById('monster-art');
    const fileInput = document.getElementById('imageUpload');
    const jsonInput = document.getElementById('jsonUpload');

    const editableSelectors = [
      '.monster-header',
      '.monster-subtitle',
      '.monster-lore',
      '.stat-block'
    ];
    const editableAreas = editableSelectors
      .map(sel => document.querySelector(sel))
      .filter(Boolean);

    let isRestoring = false;
    let undoStack = [];
    let redoStack = [];
    let currentMonsterId = null;
    let currentTemplateId = 'standard';

    const viewLibrary = document.getElementById('view-library');
    const viewEditor  = document.getElementById('view-editor');
    const monsterListEl = document.getElementById('monster-list');
    const monsterEmptyEl = document.getElementById('monster-empty');
    const monsterSearchInput = document.getElementById('monster-search');
    const templateSelectEl = document.getElementById('template-select');

    function showView(name) {
      if (name === 'library') {
        viewLibrary.style.display = 'block';
        viewEditor.style.display = 'none';
      } else {
        viewLibrary.style.display = 'none';
        viewEditor.style.display = 'block';
      }
    }

    function getState() {
      const contents = {};
      editableSelectors.forEach(sel => {
        const el = document.querySelector(sel);
        contents[sel] = el ? el.innerHTML : '';
      });
      return {
        contents,
        imgSrc: img.src || ''
      };
    }

    function applyState(state) {
      if (!state) return;
      isRestoring = true;
      Object.entries(state.contents).forEach(([sel, html]) => {
        const el = document.querySelector(sel);
        if (el) {
          el.innerHTML = html;
          el.dataset.lastContent = html;
        }
      });
      img.src = state.imgSrc || '';
      isRestoring = false;
    }

    function snapshot() {
      const state = getState();
      undoStack.push(state);
      if (undoStack.length > 50) undoStack.shift();
      redoStack = [];
    }

    function undo() {
      if (undoStack.length <= 1) return;
      const current = undoStack.pop();
      redoStack.push(current);
      const previous = undoStack[undoStack.length - 1];
      applyState(previous);
    }

    function redo() {
      if (!redoStack.length) return;
      const next = redoStack.pop();
      undoStack.push(next);
      applyState(next);
    }

    function placeCaretAtEnd(el) {
      el.focus();
      if (typeof window.getSelection != "undefined"
          && typeof document.createRange != "undefined") {
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }

    function placeCaretInElement(el) {
      if (!el) return;
      el.focus();
      if (typeof window.getSelection != "undefined"
          && typeof document.createRange != "undefined") {
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(true);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }

    editableAreas.forEach(area => {
      area.dataset.lastContent = area.innerHTML;

      area.addEventListener('focus', () => {
        area.dataset.lastContent = area.innerHTML;
      });

      area.addEventListener('input', () => {
        if (isRestoring) return;

        const overflows = page.scrollHeight > page.clientHeight + 1;
        if (overflows) {
          isRestoring = true;
          area.innerHTML = area.dataset.lastContent;
          placeCaretAtEnd(area);
          isRestoring = false;
        } else {
          area.dataset.lastContent = area.innerHTML;
        }
      });

      area.addEventListener('blur', () => {
        if (isRestoring) return;
        snapshot();
      });
    });

    snapshot();

    fileInput.addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        img.src = e.target.result;
        snapshot();
      };
      reader.readAsDataURL(file);
    });

    jsonInput.addEventListener('change', handleJsonImport);

    function exportPDF() {
      window.print();
    }

    function downloadFromDataUrl(dataUrl, filename) {
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function capturePageAsPngDataUrl(scale) {
      if (typeof html2canvas === 'undefined') {
        alert('Funzione di esportazione immagine non disponibile.');
        throw new Error('html2canvas missing');
      }
      const canvas = await html2canvas(page, {
        scale: scale,
        backgroundColor: null,
        useCORS: true
      });
      return canvas.toDataURL('image/png');
    }

    function dataURLToBlob(dataUrl) {
      const parts = dataUrl.split(',');
      const mimeMatch = parts[0].match(/:(.*?);/);
      const mime = mimeMatch ? mimeMatch[1] : 'image/png';
      const bstr = atob(parts[1]);
      let n = bstr.length;
      const u8 = new Uint8Array(n);
      while (n--) {
        u8[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8], { type: mime });
    }

    async function exportPngWithChoice() {
      const ok = window.confirm(
        'Vuoi scaricare la versione NITIDA?\n\nOK = Nitida (file più pesante)\nAnnulla = Bilanciata (file più leggero)'
      );
      const scale = ok ? 3 : 2;
      try {
        const dataUrl = await capturePageAsPngDataUrl(scale);
        const monster = getCurrentMonsterObject();
        const safeName = (monster.name || 'mostro').replace(/[^a-z0-9_\-]+/gi, '_');
        downloadFromDataUrl(dataUrl, safeName + '.png');
      } catch (e) {
        console.error(e);
      }
    }

    function exportMonsterJson() {
      const monster = getCurrentMonsterObject();
      const json = JSON.stringify(monster, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const safeName = (monster.name || 'mostro').replace(/[^a-z0-9_\-]+/gi, '_');
      downloadBlob(blob, safeName + '.json');
    }

    async function handleJsonImport(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (!data || !data.html) {
          alert('File JSON non valido per questo editor.');
          return;
        }
        if (!data.id) {
          data.id = 'm_' + Date.now();
        }
        loadMonsterIntoEditor(data);
        showView('editor');

        const now = Date.now();
        const monsterToSave = {
          ...data,
          template: data.template || 'standard',
          updatedAt: now,
          createdAt: data.createdAt || now
        };
        await saveMonsterToDB(monsterToSave);
        await loadMonstersList();
      } catch (e) {
        console.error(e);
        alert('Errore durante l\'importazione del JSON.');
      } finally {
        jsonInput.value = '';
      }
    }

    async function exportZipWithChoice() {
      if (typeof JSZip === 'undefined') {
        alert('Funzione ZIP non disponibile.');
        return;
      }
      const ok = window.confirm(
        'Per il pacchetto ZIP vuoi includere la PNG NITIDA?\n\nOK = Nitida\nAnnulla = Bilanciata'
      );
      const scale = ok ? 3 : 2;
      try {
        const monster = getCurrentMonsterObject();
        const safeName = (monster.name || 'mostro').replace(/[^a-z0-9_\-]+/gi, '_');

        const zip = new JSZip();
        const json = JSON.stringify(monster, null, 2);
        zip.file(safeName + '.json', json);

        const dataUrl = await capturePageAsPngDataUrl(scale);
        const pngBlob = dataURLToBlob(dataUrl);
        const arrayBuffer = await pngBlob.arrayBuffer();
        zip.file(safeName + '.png', arrayBuffer);

        const zipBlob = await zip.generateAsync({ type: 'blob' });
        downloadBlob(zipBlob, safeName + '.zip');
      } catch (e) {
        console.error(e);
        alert('Errore durante la creazione dello ZIP.');
      }
    }

    document.querySelectorAll('.toolbar .btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.action;
        if (action === 'export') exportPDF();
        else if (action === 'export-png') exportPngWithChoice();
        else if (action === 'export-json') exportMonsterJson();
        else if (action === 'export-zip') exportZipWithChoice();
        else if (action === 'undo') undo();
        else if (action === 'redo') redo();
        else if (action === 'save') saveCurrentMonster();
        else if (action === 'library') {
          showView('library');
          loadMonstersList();
        }
        else if (action === 'add-trait') {
          insertStatTemplate('trait');
        }
        else if (action === 'add-multi') {
          insertStatTemplate('multi');
        }
        else if (action === 'add-action') {
          insertStatTemplate('action');
        }
        else if (action === 'add-legendary') {
          insertStatTemplate('legendary');
        }
        else if (action === 'add-reaction') {
          insertStatTemplate('reaction');
        }
        else if (action === 'text-dark') {
          page.style.color = '#2a1208';
        }
      });
    });

    function insertStatTemplate(type) {
      const statBlock = document.querySelector('.stat-block');
      if (!statBlock) return;

      let html = '';
      let focusSelector = '';

      if (type === 'trait') {
        html = `
          <div class="stat-row">
            <div class="trait">
              <span class="trait-name">Nome del Tratto.</span>
              Descrizione del tratto...
            </div>
          </div>
        `;
        focusSelector = '.stat-row:last-child .trait-name';
      } else if (type === 'multi') {
        html = `
          <div class="stat-row">
            <div class="action">
              <span class="action-name">Multiattacco.</span>
              Il mostro effettua due o più attacchi con le sue armi naturali. <i>(Modifica questo testo)</i>
            </div>
          </div>
        `;
        focusSelector = '.stat-row:last-child .action-name';
      } else if (type === 'action') {
        html = `
          <div class="stat-row">
            <div class="action">
              <span class="action-name">Nome dell'Azione.</span>
              Attacco in mischia o a distanza con arma: +X al tiro per colpire, portata X m, un bersaglio. <i>(Modifica questo testo)</i>
            </div>
          </div>
        `;
        focusSelector = '.stat-row:last-child .action-name';
      } else if (type === 'legendary') {
        html = `
          <div class="stat-row">
            <span class="section-label">Azioni Leggendarie</span>
            <div class="action">
              <span class="action-name">Nome Azione Leggendaria.</span>
              Il mostro compie un'azione leggendaria scegliendo tra le opzioni disponibili. <i>(Modifica questo testo)</i>
            </div>
          </div>
        `;
        focusSelector = '.stat-row:last-child .action-name';
      } else if (type === 'reaction') {
        html = `
          <div class="stat-row">
            <span class="section-label">Reazioni</span>
            <div class="action">
              <span class="action-name">Nome della Reazione.</span>
              Descrizione della reazione... <i>(Modifica questo testo)</i>
            </div>
          </div>
        `;
        focusSelector = '.stat-row:last-child .action-name';
      }

      statBlock.insertAdjacentHTML('beforeend', html);
      statBlock.dataset.lastContent = statBlock.innerHTML;
      snapshot();

      const focusEl = statBlock.querySelector(focusSelector);
      if (focusEl) {
        placeCaretInElement(focusEl);
      }
    }

    /* IndexedDB */
    const DB_NAME = 'mostroAppDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'monsters';

    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            store.createIndex('name', 'name', { unique: false });
          }
        };

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function saveMonsterToDB(monster) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const request = store.put(monster);
        request.onsuccess = () => resolve(true);
        request.onerror = () => reject(request.error);
      });
    }

    async function getMonsterFromDB(id) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result || null);
        request.onerror = () => reject(request.error);
      });
    }

    async function deleteMonsterFromDB(id) {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);
        const request = store.delete(id);
        request.onsuccess = () => resolve(true);
        request.onerror = () => reject(request.error);
      });
    }

    async function getAllMonstersFromDB() {
      const db = await openDB();
      return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE_NAME, 'readonly');
        const store = tx.objectStore(STORE_NAME);
        const monsters = [];

        const request = store.openCursor();
        request.onsuccess = (event) => {
          const cursor = event.target.result;
          if (cursor) {
            monsters.push(cursor.value);
            cursor.continue();
          } else {
            resolve(monsters);
          }
        };
        request.onerror = () => reject(request.error);
      });
    }

    function getEditorText(el) {
      return el ? el.textContent.trim() : '';
    }

    function getCurrentMonsterObject() {
      const headerEl   = document.querySelector('.monster-header');
      const subtitleEl = document.querySelector('.monster-subtitle');

      const name = getEditorText(headerEl) || 'Mostro senza nome';
      const typeLine = getEditorText(subtitleEl) || '';
      const now = Date.now();

      return {
        id: currentMonsterId || ('m_' + now),
        name,
        typeLine,
        template: currentTemplateId || 'standard',
        cr: '',
        createdAt: currentMonsterId ? undefined : now,
        updatedAt: now,
        html: {
          header: document.querySelector('.monster-header')?.innerHTML || '',
          subtitle: document.querySelector('.monster-subtitle')?.innerHTML || '',
          lore: document.querySelector('.monster-lore')?.innerHTML || '',
          stats: document.querySelector('.stat-block')?.innerHTML || ''
        },
        imageDataUrl: img.src || ''
      };
    }

    function loadMonsterIntoEditor(monster) {
      currentMonsterId = monster.id || null;
      currentTemplateId = monster.template || 'standard';

      const state = {
        contents: {
          '.monster-header': monster.html?.header || 'Nome del Mostro',
          '.monster-subtitle': monster.html?.subtitle || 'Taglia media, mostruosità, neutrale malvagio',
          '.monster-lore': monster.html?.lore || '',
          '.stat-block': monster.html?.stats || ''
        },
        imgSrc: monster.imageDataUrl || ''
      };

      applyState(state);
      undoStack = [getState()];
      redoStack = [];
    }

    function buildDefaultStateByTemplate(templateId) {
      let header = 'Nome del Mostro';
      let subtitle = 'Taglia media, mostruosità, neutrale malvagio';
      let lore = '';
      let stats = '';

      if (templateId === 'boss') {
        header = 'Nome del Boss';
        subtitle = 'Taglia grande, mostruosità, caotico malvagio (leggendario)';
        lore = `
          <p>
            Questo è un boss leggendario, centro di una trama o di uno scontro importante.
            Descrivi il suo dominio, i suoi obiettivi e perché i personaggi lo affrontano.
          </p>
          <p>
            Aggiungi dettagli scenici: ambiente, effetti speciali, frasi iconiche.
          </p>
        `;
        stats = `
          <div class="stat-title">
            Blocco statistiche (Boss)
          </div>

          <div class="stat-row">
            <span class="section-label">Classe Armatura</span> 18 (armatura naturale)<br>
            <span class="section-label">Punti Ferita</span> 200 (16d10 + 96)<br>
            <span class="section-label">Velocità</span> 9 m
          </div>

          <div class="stat-row">
            <div class="ability-grid">
              <div class="ability"><span>FOR</span><span class="score">22 (+6)</span></div>
              <div class="ability"><span>DES</span><span class="score">14 (+2)</span></div>
              <div class="ability"><span>COS</span><span class="score">22 (+6)</span></div>
              <div class="ability"><span>INT</span><span class="score">16 (+3)</span></div>
              <div class="ability"><span>SAG</span><span class="score">14 (+2)</span></div>
              <div class="ability"><span>CAR</span><span class="score">18 (+4)</span></div>
            </div>
          </div>

          <div class="stat-row">
            <span class="section-label">Tiri Salvezza</span> FOR +10, COS +10, SAG +6, CAR +8<br>
            <span class="section-label">Abilità</span> Percezione +10, Intimidire +8<br>
            <span class="section-label">Resistenze ai Danni</span> contundente, perforante e tagliente da attacchi non magici<br>
            <span class="section-label">Immunità alle Condizioni</span> spaventato<br>
            <span class="section-label">Sensi</span> scurovisione 18 m, Percezione passiva 20<br>
            <span class="section-label">Linguaggi</span> comuni del mondo<br>
            <span class="section-label">Grado di Sfida</span> 15 (13.000 PE)
          </div>

          <div class="stat-row">
            <div class="trait">
              <span class="trait-name">Presenza Terrificante.</span>
              Le creature a scelta entro 18 metri che vedono il boss devono superare un tiro salvezza
              su Saggezza o restare spaventate per 1 minuto.
            </div>
            <div class="trait">
              <span class="trait-name">Resistenza Leggendaria (3/Giorno).</span>
              Se il boss fallisce un tiro salvezza, può scegliere di considerarlo riuscito.
            </div>
          </div>

          <div class="stat-row">
            <span class="section-label">Azioni</span>
            <div class="action">
              <span class="action-name">Multiattacco.</span>
              Il boss effettua tre attacchi in mischia.
            </div>
            <div class="action">
              <span class="action-name">Attacco Potente.</span>
              Descrivi qui un attacco devastante del boss.
            </div>
          </div>

          <div class="stat-row">
            <span class="section-label">Azioni Leggendarie</span>
            <div class="action">
              <span class="action-name">Azione Leggendaria di Esempio.</span>
              Il boss spende un'azione leggendaria per compiere un effetto speciale.
            </div>
          </div>
        `;
      } else if (templateId === 'npc') {
        header = 'Nome del PNG';
        subtitle = 'Umanoide (qualsiasi razza), qualsiasi allineamento';
        lore = `
          <p>
            Questo è un PNG importante: alleato, antagonista o figura chiave della storia.
            Descrivi personalità, motivazioni, paure e desideri.
          </p>
          <p>
            Aggiungi dettagli su come parla, si muove e che impressione dà ai personaggi.
          </p>
        `;
        stats = `
          <div class="stat-title">
            Blocco statistiche (PNG)
          </div>

          <div class="stat-row">
            <span class="section-label">Classe Armatura</span> 12 (armatura leggera)<br>
            <span class="section-label">Punti Ferita</span> 27 (6d8)<br>
            <span class="section-label">Velocità</span> 9 m
          </div>

          <div class="stat-row">
            <div class="ability-grid">
              <div class="ability"><span>FOR</span><span class="score">10 (+0)</span></div>
              <div class="ability"><span>DES</span><span class="score">12 (+1)</span></div>
              <div class="ability"><span>COS</span><span class="score">10 (+0)</span></div>
              <div class="ability"><span>INT</span><span class="score">14 (+2)</span></div>
              <div class="ability"><span>SAG</span><span class="score">12 (+1)</span></div>
              <div class="ability"><span>CAR</span><span class="score">14 (+2)</span></div>
            </div>
          </div>

          <div class="stat-row">
            <span class="section-label">Abilità</span> Persuasione +4, Inganno +4, Intuizione +3<br>
            <span class="section-label">Sensi</span> Percezione passiva 11<br>
            <span class="section-label">Linguaggi</span> comuni del mondo<br>
            <span class="section-label">Grado di Sfida</span> 1 (200 PE)
          </div>

          <div class="stat-row">
            <div class="trait">
              <span class="trait-name">Carisma Naturale.</span>
              Il PNG ha vantaggio alle prove di Carisma quando tratta con popolazione locale.
            </div>
          </div>

          <div class="stat-row">
            <span class="section-label">Azioni</span>
            <div class="action">
              <span class="action-name">Attacco con Arma.</span>
              Colpo con arma semplice o da mischia, adatto al ruolo del PNG.
            </div>
          </div>
        `;
      } else if (templateId === 'minion') {
        header = 'Nome del Minion';
        subtitle = 'Taglia piccola, mostruosità, neutrale malvagio';
        lore = `
          <p>
            Questa è una creatura da branco o minion: debole singolarmente
            ma pericolosa in gruppo.
          </p>
          <p>
            Descrivi come si muove in branco, che ruolo ha nello scontro
            e come reagisce quando viene ferita o il capo viene ucciso.
          </p>
        `;
        stats = `
          <div class="stat-title">
            Blocco statistiche (Minion)
          </div>

          <div class="stat-row">
            <span class="section-label">Classe Armatura</span> 13 (armatura naturale o cuoio)<br>
            <span class="section-label">Punti Ferita</span> 7 (2d6)<br>
            <span class="section-label">Velocità</span> 9 m
          </div>

          <div class="stat-row">
            <div class="ability-grid">
              <div class="ability"><span>FOR</span><span class="score">8 (-1)</span></div>
              <div class="ability"><span>DES</span><span class="score">14 (+2)</span></div>
              <div class="ability"><span>COS</span><span class="score">10 (+0)</span></div>
              <div class="ability"><span>INT</span><span class="score">6 (-2)</span></div>
              <div class="ability"><span>SAG</span><span class="score">10 (+0)</span></div>
              <div class="ability"><span>CAR</span><span class="score">8 (-1)</span></div>
            </div>
          </div>

          <div class="stat-row">
            <span class="section-label">Abilità</span> Furtività +4<br>
            <span class="section-label">Sensi</span> scurovisione 18 m, Percezione passiva 10<br>
            <span class="section-label">Linguaggi</span> comprende un linguaggio semplice ma non può parlarlo<br>
            <span class="section-label">Grado di Sfida</span> 1/4 (50 PE)
          </div>

          <div class="stat-row">
            <div class="trait">
              <span class="trait-name">Attacco di Branco.</span>
              Il minion ha vantaggio ai tiri per colpire se almeno un suo alleato
              non incapacitato si trova entro 1,5 m dal bersaglio.
            </div>
          </div>

          <div class="stat-row">
            <span class="section-label">Azioni</span>
            <div class="action">
              <span class="action-name">Morso o Artigli.</span>
              Attacco base del minion. Adattalo alla creatura scelta.
            </div>
          </div>
        `;
      } else {
        header = 'Nome del Mostro';
        subtitle = 'Taglia media, mostruosità, neutrale malvagio';
        lore = `
          <p>
            Scrivi qui la descrizione narrativa del mostro: origine, comportamento,
            territorio, leggende e qualsiasi dettaglio utile al master.
          </p>
          <p>
            Questa sezione è completamente editabile: clicca e scrivi come in un documento.
          </p>
        `;
        stats = `
          <div class="stat-title">
            Blocco statistiche
          </div>

          <div class="stat-row">
            <span class="section-label">Classe Armatura</span> 15 (pelle coriacea)<br>
            <span class="section-label">Punti Ferita</span> 68 (8d10 + 24)<br>
            <span class="section-label">Velocità</span> 9 m
          </div>

          <div class="stat-row">
            <div class="ability-grid">
              <div class="ability"><span>FOR</span><span class="score">16 (+3)</span></div>
              <div class="ability"><span>DES</span><span class="score">14 (+2)</span></div>
              <div class="ability"><span>COS</span><span class="score">16 (+3)</span></div>
              <div class="ability"><span>INT</span><span class="score">8 (-1)</span></div>
              <div class="ability"><span>SAG</span><span class="score">12 (+1)</span></div>
              <div class="ability"><span>CAR</span><span class="score">10 (+0)</span></div>
            </div>
          </div>

          <div class="stat-row">
            <span class="section-label">Tiri Salvezza</span> DES +4, COS +5<br>
            <span class="section-label">Abilità</span> Percezione +3, Furtività +4<br>
            <span class="section-label">Sensi</span> scurovisione 18 m, Percezione passiva 13<br>
            <span class="section-label">Linguaggi</span> —<br>
            <span class="section-label">Grado di Sfida</span> 4 (1.100 PE)
          </div>

          <div class="stat-row">
            <div class="trait">
              <span class="trait-name">Fiuto del Predatore.</span>
              Testo abilità speciale…
            </div>
            <div class="trait">
              <span class="trait-name">Agguato.</span>
              Testo abilità speciale…
            </div>
          </div>

          <div class="stat-row">
            <span class="section-label">Azioni</span>
            <div class="action">
              <span class="action-name">Multiattacco.</span>
              Testo azione…
            </div>
            <div class="action">
              <span class="action-name">Artigli.</span>
              Testo attacco…
            </div>
          </div>
        `;
      }

      return {
        contents: {
          '.monster-header': header,
          '.monster-subtitle': subtitle,
          '.monster-lore': lore,
          '.stat-block': stats
        },
        imgSrc: ''
      };
    }

    function resetEditorToTemplate(templateId) {
      currentTemplateId = templateId || 'standard';
      const defaultState = buildDefaultStateByTemplate(currentTemplateId);
      applyState(defaultState);
      undoStack = [getState()];
      redoStack = [];
    }

    function resetEditorToDefault() {
      resetEditorToTemplate('standard');
    }

    async function saveCurrentMonster() {
      const monster = getCurrentMonsterObject();

      if (currentMonsterId && !monster.createdAt) {
        const existing = await getMonsterFromDB(currentMonsterId);
        if (existing && existing.createdAt) {
          monster.createdAt = existing.createdAt;
        } else {
          monster.createdAt = Date.now();
        }
      } else if (!monster.createdAt) {
        monster.createdAt = Date.now();
      }

      await saveMonsterToDB(monster);
      currentMonsterId = monster.id;

      undoStack = [getState()];
      redoStack = [];

      alert('Mostro salvato.');
      await loadMonstersList();
    }

    function formatDate(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function templateLabel(t) {
      switch (t) {
        case 'boss': return 'Boss';
        case 'npc': return 'PNG';
        case 'minion': return 'Minion';
        default: return 'Standard';
      }
    }

    async function loadMonstersList() {
      const all = await getAllMonstersFromDB();
      const term = monsterSearchInput.value.trim().toLowerCase();

      let monsters = all;

      if (term) {
        monsters = all.filter(m => {
          const name = (m.name || '').toLowerCase();
          const typeLine = (m.typeLine || '').toLowerCase();
          return name.includes(term) || typeLine.includes(term);
        });
      }

      monsters.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

      monsterListEl.innerHTML = '';

      if (!monsters.length) {
        monsterEmptyEl.style.display = 'block';
        return;
      }
      monsterEmptyEl.style.display = 'none';

      monsters.forEach(m => {
        const card = document.createElement('div');
        card.className = 'monster-card';
        card.dataset.id = m.id;

        const main = document.createElement('div');
        main.className = 'monster-card-main';

        const title = document.createElement('div');
        title.className = 'monster-card-title';
        title.textContent = m.name || 'Mostro senza nome';

        const subtitle = document.createElement('div');
        subtitle.className = 'monster-card-subtitle';
        subtitle.textContent = m.typeLine || '';

        const meta = document.createElement('div');
        meta.className = 'monster-card-meta';
        let metaText = 'Ultima modifica: ' + formatDate(m.updatedAt);
        metaText += ' · Template: ' + templateLabel(m.template);
        meta.textContent = metaText;

        main.appendChild(title);
        main.appendChild(subtitle);
        main.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'monster-card-actions';

        const btnOpen = document.createElement('button');
        btnOpen.textContent = 'Apri';
        btnOpen.dataset.action = 'open';
        btnOpen.dataset.id = m.id;

        const btnDup = document.createElement('button');
        btnDup.textContent = 'Duplica';
        btnDup.dataset.action = 'dup';
        btnDup.dataset.id = m.id;

        const btnDel = document.createElement('button');
        btnDel.textContent = 'Elimina';
        btnDel.dataset.action = 'del';
        btnDel.dataset.id = m.id;

        actions.appendChild(btnOpen);
        actions.appendChild(btnDup);
        actions.appendChild(btnDel);

        card.appendChild(main);
        card.appendChild(actions);

        monsterListEl.appendChild(card);
      });
    }

    monsterSearchInput.addEventListener('input', () => {
      loadMonstersList();
    });

    monsterListEl.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id;
      if (!id) return;

      if (action === 'open') {
        const monster = await getMonsterFromDB(id);
        if (!monster) {
          alert('Mostro non trovato.');
          return;
        }
        loadMonsterIntoEditor(monster);
        showView('editor');
      } else if (action === 'dup') {
        const monster = await getMonsterFromDB(id);
        if (!monster) {
          alert('Mostro non trovato.');
          return;
        }
        const now = Date.now();
        monster.id = 'm_' + now;
        monster.name = monster.name + ' (copia)';
        monster.createdAt = now;
        monster.updatedAt = now;
        await saveMonsterToDB(monster);
        await loadMonstersList();
      } else if (action === 'del') {
        const ok = confirm('Sei sicuro di voler eliminare questo mostro?');
        if (!ok) return;
        await deleteMonsterFromDB(id);
        if (currentMonsterId === id) {
          currentMonsterId = null;
        }
        await loadMonstersList();
      }
    });

    document.getElementById('btn-new-monster').addEventListener('click', () => {
      const tmpl = templateSelectEl ? templateSelectEl.value : 'standard';
      resetEditorToTemplate(tmpl);
      showView('editor');
    });

    (async function initApp() {
      showView('library');
      await loadMonstersList();
    })();
  </script>

</body>
</html>
